---
title: "Análisis de expresion de genes diferenciales en microarreglos"
author: "Paul Arturo Gamez Coronel"
date: "2023-11-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Primeramente cargamos la librerias que necesitaremos, si es necesario tambien las instalaremos en caso de que no esten presentes en nuestro Rstudio.

```{r cargar_librerias}
library(affy)
library(affyPLM)
library(limma)
library(annaffy)
library(gplots)
library(arrayQualityMetrics)
library(ath1121501.db)

```

Una vez tenemos las librerias cargadas, proceredemos a usar la libreria **affy** para leer los datos de nuestro microarreglo, con la funcion **ReadAffy** cargamos los datos de el directorio en el que estemos trabajando, y con el argumento **verbose** podremos leer de la consola la informacion a la vez que esta es cargada.

```{r cargar datos}
rawData <- ReadAffy(verbose=TRUE)
```

Usando la funcion **image** podremos ver una reproduccion de la foto del escaner de fluoresencia de la placa de microarreglos. 

```{r imagen_cruda}
image(rawData[,1],col=rainbow(100))
```

Con la funcion **arrayQualityMetrics** podremos hacer un resumen de un analisis de calidad de nuestros datos, lo que nos permitira ver la calidad de los mismos.

```{r diseño_placa}
arrayQualityMetrics(expressionset = rawData, outdir = "Quality_Metrics", force = TRUE, do.logtransform =  TRUE)
```

Con la funcion **boxplot** podremos observar los parametros de los datros con una grafica de caja de las 8 placas de microarreglos, tambien realizaremos un histograma

```{r boxplot_histogramRAW}
boxplot(rawData,col=rainbow(30),las=2,ylab="Fluorescencia")
hist(rawData,col=rainbow(30))
```

Usando el algoritmo **RMA** nos perimitira realizar una correcion, normalizacion, y estimacion de los niveles de expresion en un logaritmo de 2. 

```{r rma_algoritm}
eset <- rma(rawData)
```

Nuevamente podemos realizar un grafico de caja y un histograma despues del usar el algoritmo **RMA** para ver como cambiaron nuestros datos y ver de mejor manera como funciono y cambiaron en funcion de este algoritmo

```{r boxplot_histogram}
boxplot(eset,col=rainbow(30),las=2,ylab="Fluorescencia")
hist(eset,col=rainbow(30))
```

Usando la funcion **exprs** veremos los niveles de expresion de los datos procesados con el algoritmo RMA.

```{r expresion_level}
expression.level <- exprs(eset)
head(expression.level)
dim(expression.level)
```

El nombre de las columnas de nuestros dataframes toma el nombre de los ficheros del cual se leyeron los datos, por lo que sera necesario remplazar los nombres por unos que podamos usar para asi tambien que sea mas eficiente la forma de interpretar los datos. 

```{r renombrar_columnas}
samplesNames <- c("WT_with_Fe_1","WT_with_Fe_2","WT_no_Fe_1","WT_no_Fe_2",
                  "pye_with_Fe_1","pye_with_Fe_2","pye_no_Fe_1","pye_no_Fe_2")
colnames(expression.level) <- samplesNames
head(expression.level)
```

En el caso de estos datos que estamos tratando, tenemos 8 condiciones, las cuales son con y sin hierrro y tenemos 2 genotipos diferentes, el genotipo **WT** y el genotipo **PYE** (popeye), por lo que tenemos 2 replicas de cada genitipo y ademas tenemos uno que es positivo en hierro y uno negativo en hierro en cada replica del genotipo.

```{r expression_value_mean}
wt.with.fe <- (expression.level[,"WT_with_Fe_1"] + 
                 expression.level[,"WT_with_Fe_2"])/2

wt.no.fe <- (expression.level[,"WT_no_Fe_1"] + 
               expression.level[,"WT_no_Fe_2"])/2

pye.with.fe <- (expression.level[,"pye_with_Fe_1"] + 
                  expression.level[,"pye_with_Fe_2"])/2

pye.no.fe <- (expression.level[,"pye_no_Fe_1"] + 
                expression.level[,"pye_no_Fe_2"])/2

mean.expression <- matrix(c(wt.with.fe,wt.no.fe,
                            pye.with.fe,pye.no.fe),ncol=4)
```

Crearemos una matriz que contenga la expresion emdai de cada genotipo con o sin hierro

```{r value_mean_condition}
conditions <- c("WT_with_Fe","WT_no_Fe","pye_with_Fe","pye_no_Fe")
rownames(mean.expression) <- names(wt.with.fe)
colnames(mean.expression) <- conditions
head(mean.expression)
```

Por defecto, el nombre de las columnas coincide con el nombre del correspondiente fichero CEL. Estos nombres no son informativos y conducen fácilmente a error. Por lo tanto, renombramos apropiadamente las columnas con el nombre de las muestras. 

```{r nombrar_columnas}
sampleID <- c("WT_with_Fe_1","WT_with_Fe_2","WT_no_Fe_1","WT_no_Fe_2","pye_with_Fe_1","pye_with_Fe_2","pye_no_Fe_1","pye_no_Fe_2")
colnames(expression.level) <- sampleID
head(expression.level)
```

Realizaremos una visualizacion comparativa de los transcriptomas de los 2 genotipos usando graficos de dispersion (scatterplot), cada punto en el eje X representa el nivel de expresresion de la respectiva condicion, lo mismo para el eje Y, mientras mas diagonal sea un punto significa que no se expresa diferencialmente.

```{r plots}
plot(wt.with.fe,wt.no.fe,xlab="WT with Fe",ylab="WT no Fe",pch=19,cex=0.5)
plot(pye.with.fe,pye.no.fe,xlab="pye with Fe",ylab="pye no Fe",pch=19,cex=0.5)
plot(wt.with.fe,pye.with.fe,xlab="WT with Fe",ylab="pye with Fe",pch=19,cex=0.5)
plot(wt.no.fe,pye.no.fe,xlab="WT no Fe",ylab="pye no Fe",pch=19,cex=0.5)
```

Necesitamos realizar un diseño del experimento, recordemos que tenemos 2 condiciones (Fe+ y Fe-), 2 genotipos(WT y PYE) y tenemos 2 replicas por cada uno, por lo que necesitaremos evaluar las 2 condiciones con los 2 genotipos y por cada uno de estos tendremos que evaluar las 2 replicas que tenemos.

```{r exprerimental_design}
eDesign <- model.matrix(~ -1+factor(c(1,1,2,2,3,3,4,4)))
colnames(eDesign) <- c("WT_with_Fe","WT_no_Fe",
                       "pye_with_Fe","pye_no_Fe")
```

Ahora realizaremos un ajuste de la estimacion con un modelo lineal usando el diseño experimental anteriormente declarado, tambien determinaremos los genes expresados usando una matriz de contraste comparando los genotipos que se van a compararar, en este caso compararemos cada genotipo con su condicion de con o sin hierro.

```{r fit_contrast.matrix}
linear.fit <- lmFit(eset,eDesign)

contrast.matrix <- makeContrasts(WT_no_Fe-WT_with_Fe,
                                 pye_no_Fe-pye_with_Fe,
                                 pye_with_Fe-WT_with_Fe,
                                 pye_no_Fe-WT_no_Fe,
                                 levels=c("WT_with_Fe","WT_no_Fe",
                                          "pye_with_Fe","pye_no_Fe"))
```

ahora que tenemos la matriz de contraste podemos calcular el fold-change y los valores p para cada genotipo

```{r fc_p_values}
contrast.linear.fit <- contrasts.fit(linear.fit, contrast.matrix)
contrast.results <- eBayes(contrast.linear.fit)
```



```{r experimnetal_design}
WT.with.no.Fe <- topTable(contrast.results, number=22810,coef=1,sort.by="logFC")
head(WT.with.no.Fe)

pye.with.no.Fe <- topTable(contrast.results, number=22810,coef=2,sort.by="logFC")
head(pye.with.no.Fe)

fold.change.WT.with.no.Fe <- WT.with.no.Fe$logFC
genes.ids.WT.with.no.Fe <- rownames(WT.with.no.Fe)

```

usando la funcion *topTable* podemos ver un marco de datos con la informacion de la expresion diferencial de genes usando el logaritmo

```{r topTable}
WT.with.no.Fe <- topTable(contrast.results, number=22810,coef=1,sort.by="logFC")
head(WT.with.no.Fe)

pye.with.no.Fe <- topTable(contrast.results, number=22810,coef=2,sort.by="logFC")
head(pye.with.no.Fe)

```

## Metodo Fold-Change
Este metodo se utiliza para comparar los transcriptomas de dos genotipos diferentes o de uno mismo bajo 2 condiciones distintas, lo que nos permitira analizar tanto la condicion de sin o con hierro como los trasncriptomas de el genotipo WT y PYE

```{r foldChange}
fold.change.WT.with.no.Fe <- WT.with.no.Fe$logFC
genes.ids.WT.with.no.Fe <- rownames(WT.with.no.Fe)

activated.genes.WT.with.no.Fe.1 <- genes.ids.WT.with.no.Fe[fold.change.WT.with.no.Fe > 1]
repressed.genes.WT.with.no.Fe.1 <- genes.ids.WT.with.no.Fe[fold.change.WT.with.no.Fe < - 1]

fold.change.pye.with.no.Fe <- pye.with.no.Fe$logFC
genes.ids.pye.with.no.Fe <- rownames(pye.with.no.Fe)

activated.genes.pye.with.no.Fe.1 <- genes.ids.pye.with.no.Fe[fold.change.pye.with.no.Fe > 1]
repressed.genes.pye.with.no.Fe.1 <- genes.ids.pye.with.no.Fe[fold.change.pye.with.no.Fe < - 1]

length(activated.genes.WT.with.no.Fe.1)
length(repressed.genes.WT.with.no.Fe.1)
```

Ahora que tenemos todos estos datos procesados generaremos un scaterplot mas acetado de todas las condiciones y analizaremos ciertos genes expresados para ver nivel de expresion

```{r scatterplots}
plot(wt.with.fe,wt.no.fe,pch=19,cex=0.5,col="grey",xlab="WT with Fe",ylab="WT no Fe")

points(wt.with.fe[activated.genes.WT.with.no.Fe.1],
       wt.no.fe[activated.genes.WT.with.no.Fe.1],pch=19,cex=0.5,col="red")

points(wt.with.fe[repressed.genes.WT.with.no.Fe.1],
       wt.no.fe[repressed.genes.WT.with.no.Fe.1],pch=19,cex=0.5,col="blue")

text(wt.with.fe["254550_at"]+0.3,wt.no.fe["254550_at"]+0.3,"IRT1", col="black", cex=0.7)
text(wt.with.fe["252427_at"]+0.3,wt.no.fe["252427_at"]+0.3,"PYE", col="black", cex=0.7)
text(wt.with.fe["257062_at"]+0.3,wt.no.fe["257062_at"]+0.3,"BTS", col="black", cex=0.7)
text(wt.with.fe["251109_at"]+0.3,wt.no.fe["251109_at"]+0.3,"FER1", col="black", cex=0.7)
```

####Anotación de los genes expresados de forma diferencial

Usando la libreria **annaffy** podemos guardar la informacion de los genes expresados diferencialmente en un formato de html y txt para consultar de mejor manera estos genes teniendo su localizacion, id de genes en el ncbi y ontologia de los mismos.

```{r tabbleshtml}
activated.genes.WT.with.no.Fe.1.table <- aafTableAnn(activated.genes.WT.with.no.Fe.1, 
                                                     "ath1121501.db", aaf.handler())
saveHTML(activated.genes.WT.with.no.Fe.1.table, 
         file="activated_genes_WT_with_no_Fe_1.html")
saveText(activated.genes.WT.with.no.Fe.1.table, 
         file="activated_genes_WT_with_no_Fe_1.txt")

repressed.genes.WT.with.no.Fe.1.table <- aafTableAnn(repressed.genes.WT.with.no.Fe.1, 
                                                     "ath1121501.db", aaf.handler())
saveHTML(repressed.genes.WT.with.no.Fe.1.table, 
         file="repressed_genes_WT_with_no_Fe_1.html")
saveText(repressed.genes.WT.with.no.Fe.1.table, 
         file="repressed_genes_WT_with_no_Fe_1.txt")



activated.genes.pye.with.no.Fe.1.table <- aafTableAnn(activated.genes.pye.with.no.Fe.1, 
                                                      "ath1121501.db", aaf.handler())
saveHTML(activated.genes.pye.with.no.Fe.1.table, 
         file="activated_genes_pye_with_no_Fe_1.html")
saveText(activated.genes.pye.with.no.Fe.1.table, 
         file="activated_genes_pye_with_no_Fe_1.txt")

repressed.genes.pye.with.no.Fe.1.table <- aafTableAnn(repressed.genes.pye.with.no.Fe.1, 
                                                      "ath1121501.db", aaf.handler())
saveHTML(repressed.genes.pye.with.no.Fe.1.table, 
         file="repressed_genes_pye_with_no_Fe_1.html")
saveText(repressed.genes.WT.with.no.Fe.1.table, 
         file="repressed_genes_pye_with_no_Fe_1.txt")
```

### Metodo de interferencia estadistica con Fold Change

este metodo se usa en ocaciones que tenemos una gran cantidad de replicas biologicas de cada gen donde compararemos un contraste de hipotesis sobre la igualdad de medias.
```{r fc_extraction}
fold.change.WT.with.no.Fe <- WT.with.no.Fe$logFC
p.value.WT.with.no.Fe <- WT.with.no.Fe$adj.P.Val
genes.ids.WT.with.no.Fe <- rownames(WT.with.no.Fe)

activated.genes.WT.with.no.Fe.2 <- genes.ids.WT.with.no.Fe[fold.change.WT.with.no.Fe > 1 & 
                                                             p.value.WT.with.no.Fe < 0.05]

repressed.genes.WT.with.no.Fe.2 <- genes.ids.WT.with.no.Fe[fold.change.WT.with.no.Fe < -1 & 
                                                             p.value.WT.with.no.Fe < 0.05]
length(activated.genes.WT.with.no.Fe.2)
length(repressed.genes.WT.with.no.Fe.2)

```

## Volcano Plot
con los volcano plot podemos representar en una grafica el fold-change y su significacia estadistica cuando utilizamos este medtodo para representar la expresion de genes diferenciales.

```{r volcano_plot}
names(fold.change.WT.with.no.Fe) <- genes.ids.WT.with.no.Fe
log.p.value.WT.with.no.Fe <- -log10(p.value.WT.with.no.Fe)
names(log.p.value.WT.with.no.Fe)  <- genes.ids.WT.with.no.Fe

plot(fold.change.WT.with.no.Fe,log.p.value.WT.with.no.Fe,
     pch=19,cex=0.5,col="grey",ylab="-log10(p value)",xlab="log2 fold change",xlim=c(-6,6))

points(fold.change.WT.with.no.Fe[activated.genes.WT.with.no.Fe.2],
       log.p.value.WT.with.no.Fe[activated.genes.WT.with.no.Fe.2],
       pch=19,cex=0.5,col="red")

points(fold.change.WT.with.no.Fe[repressed.genes.WT.with.no.Fe.2],
       log.p.value.WT.with.no.Fe[repressed.genes.WT.with.no.Fe.2],
       pch=19,cex=0.5,col="blue")

text(fold.change.WT.with.no.Fe["254550_at"],
     log.p.value.WT.with.no.Fe["254550_at"]+0.3,"IRT1", col="black")

text(fold.change.WT.with.no.Fe["251109_at"]+0.3,
     log.p.value.WT.with.no.Fe["251109_at"],"FER1", col="black")
```

### HeatMap
los mapas de calor nos permiten visalizar a gran escala los niveles de expresion de genes diferenciales con todas las condiciones analizadas que ademas podremos observar el nivel de expresion de los genes.

```{r heatmap}
DEGs.fold.change <- function(contrast.results,
                             gene.number,
                             comparison.number,
                             fold.change.threshold)
{
  ## Extraer con topTable la información de DEGs
  transcriptome.comparison <- topTable(contrast.results, number=gene.number,coef=comparison.number,sort.by="logFC")
  ## Extraer el fold change de cada gen y los nombres de las sondas (genes).
  current.fold.changes <- transcriptome.comparison[["logFC"]]
  gene.ids <- rownames(transcriptome.comparison)
  #gene.ids <- transcriptome.comparison[[1]]
  
  ## Extraer el nombre de los genes cuyo fold change excede el umbral prefijado (genes
  ## activados) o que es menor que menos el umbral prefijado (genes reprimidos).
  current.activated.genes <- gene.ids[current.fold.changes > fold.change.threshold]
  current.repressed.genes <- gene.ids[current.fold.changes < - fold.change.threshold]
  
  ## Devolver una lista cuyas componentes se identifican con los nombres "activated.genes"
  ## y "repressed.genes" y que contienen los correspondientes vectores. 
  return(list(activated.genes = current.activated.genes, repressed.genes = current.repressed.genes))
}

diff.genes.1 <- DEGs.fold.change(contrast.results,gene.number=22810,comparison.number=1,fold.change.threshold=1) 
diff.genes.2 <- DEGs.fold.change(contrast.results,gene.number=22810,comparison.number=2,fold.change.threshold=1) 
diff.genes.3 <- DEGs.fold.change(contrast.results,gene.number=22810,comparison.number=3,fold.change.threshold=1) 
diff.genes.4 <- DEGs.fold.change(contrast.results,gene.number=22810,comparison.number=4,fold.change.threshold=1) 

complete.DEGs <- c(diff.genes.1$activated.genes,
                   diff.genes.1$repressed.genes,
                   diff.genes.2$activated.genes,
                   diff.genes.2$repressed.genes,
                   diff.genes.3$activated.genes,
                   diff.genes.3$repressed.genes,
                   diff.genes.4$activated.genes,
                   diff.genes.4$repressed.genes)

complete.DEGs <- unique(complete.DEGs)


DEG.expression <- mean.expression[complete.DEGs,
                                  c("WT_with_Fe","WT_no_Fe","pye_with_Fe","pye_no_Fe")]

normalized.DEG.expression <- t(scale(t(DEG.expression)))


help(heatmap)
heatmap(normalized.DEG.expression,Colv=FALSE,dendrogram="row",
        labRow=c(""),density.info="none",trace="none",
        col=redgreen(100),margins = c(8,8),cexCol=1.2)
```